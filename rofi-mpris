#!/bin/bash
# This code is awful but it works

DEFAULT_THEME="$HOME/.config/rofi/config.rasi"
THEME="$1"
THEME2="$2"

# setting up symbols used in the menu. you`re encouraged to change them
play="󰐊"
pause="󰏤"
play_pause="󰐎"
stop_="󰓛"
next="󰒭"
prev="󰒮"
loop="󰑖"
shuffle="󰒝"
back="󰁝"

active="󰝚"
inactive="󰝛"

# setting up options shown in the second level menu. again, you are encouraged to change them
# can include $back $play $pause $play-pause $_stop $next $prev $loop $shuffle in any order
options="$stop_\n$prev\n$play_pause\n$next\n$loop"

label_all_active="Active"
label_all_inactive="Inactive"
label_all="All"

# first menu level loop
while true; do
    actual_players="$(mpris-ctl --player active --player inactive list)"
    if [[ -z $actual_players ]]; then
        rofi -e "No MPRIS players running."
        exit 0
    fi
    players=""
    players+="$label_all"$'\n'
    # players+="$label_all_active"$'\n'
    # players+="$label_all_inactive"$'\n'
    players+="$actual_players"
    readarray -t players <<<"$players"
    player_list_display=""
    for player in "${players[@]}"; do
        if [[ "$player" == "$label_all" ]]; then
            player_list_display+="$label_all"$'\n'
            continue
        elif [[ "$player" == "$label_all_inactive" ]]; then
            player_list_display+="$label_all_inactive"$'\n'
            continue
        elif [[ "$player" == "$label_all_active" ]]; then
            player_list_display+="$label_all_active"$'\n'
            continue
        fi
        if [[ "$(mpris-ctl --player "$player" status)" == "Playing" ]]; then
            status="$active"
        else
            status="$inactive"
        fi
        player_list_display+="$status $(mpris-ctl --player "$player" info "%player_name\t%artist_name - %track_name")"$'\n'
    done
    player_list_display=${player_list_display%$'\n'}
    rofi_first_param=(
        -dmenu
        -p ""
        -format i
        -theme "${THEME:-$DEFAULT_THEME}"
    )

    player_index="$(echo -e "$player_list_display" | rofi "${rofi_first_param[@]}")"
    if [[ -z $player_index ]]; then
        # $player_index is empty if rofi gets passed ESC
        break
    fi
    chosen_player="${players[$player_index]}"
    rofi_second_param=(
        -no-fixed-num-lines
        -selected-row 2
        -dmenu
        -p "$chosen_player"
        -theme "${THEME2:-${THEME:-$DEFAULT_THEME}}"
    )
    if [[ "$chosen_player" == "$label_all_active" ]]; then chosen_player="active"; fi
    if [[ "$chosen_player" == "$label_all_inactive" ]]; then chosen_player="inactive"; fi
    if [[ "$chosen_player" == "$label_all" ]]; then chosen_player="all"; fi
    # second menu level loop
    while true; do
        chosen_option="$(echo -e "$options" | rofi "${rofi_second_param[@]}")" 
        case $chosen_option in
            "$back")
                break
                ;;
            "")
                # ESC handling
                break
                ;;
            "$play")
                player_option="play"
                ;;
            "$pause")
                player_option="pause"
                ;;
            "$play_pause")
                player_option="pp"
                ;;
            "$stop_")
                player_option="stop"
                ;;
            "$next")
                player_option="next"
                ;;
            "$prev")
                player_option="prev"
                ;;
            "$loop")
                player_option="repeat --track"
                ;;
            "$shuffle")
                player_option="shuffle"
                ;;
        esac
        if [[ "$chosen_player" == "all" ]]; then
            mpris-ctl --player active --player inactive "$player_option"
        else
            mpris-ctl --player "$chosen_player" "$player_option"
        fi
    done
done
